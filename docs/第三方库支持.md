# HPL 第三方库支持

HPL 现在支持导入和使用第三方库，包括：
- Python PyPI 包
- 本地 Python 模块 (.py)
- 本地 HPL 模块 (.hpl)

## 快速开始

### 1. 安装第三方包

```bash
# 安装 PyPI 包
hpl install requests
hpl install numpy==1.24.0

# 查看已安装包
hpl list

# 卸载包
hpl uninstall requests
```

### 2. 在 HPL 中使用

```yaml
imports:
  - requests
  - numpy

main: () => {
    # 使用 requests 发送 HTTP 请求
    response = requests.get("https://api.example.com")
    echo response.status_code
    
    # 使用 numpy 进行计算
    arr = numpy.array([1, 2, 3])
    echo numpy.sum(arr)
  }
```

## 包管理命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `hpl install <pkg>` | 安装包 | `hpl install requests` |
| `hpl uninstall <pkg>` | 卸载包 | `hpl uninstall requests` |
| `hpl list` | 列出已安装包 | `hpl list` |
| `hpl search <query>` | 搜索 PyPI | `hpl search http` |
| `hpl update` | 更新所有包 | `hpl update` |
| `hpl info <pkg>` | 显示包信息 | `hpl info requests` |
| `hpl path --add <path>` | 添加模块路径 | `hpl path --add ./modules` |
| `hpl path --list` | 列出搜索路径 | `hpl path --list` |

## 模块类型

### 1. Python PyPI 包

直接安装 PyPI 上的 Python 包：

```bash
hpl install requests
hpl install pandas
hpl install pillow
```

在 HPL 中使用：

```yaml
imports:
  - requests

main: () => {
    r = requests.get("https://httpbin.org/get")
    echo r.status_code
    echo r.text
  }
```

### 2. 本地 Python 模块

创建 `my_module.py`：

```python
def hello(name):
    return f"Hello, {name}!"

VERSION = "1.0.0"
```

在同目录的 HPL 文件中导入：

```yaml
imports:
  - my_module

main: () => {
    message = my_module.hello("HPL")
    echo message
    echo my_module.VERSION
  }
```

### 3. 本地 HPL 模块

创建 `utils.hpl`：

```yaml
classes:
  StringUtils:
    reverse: (s) => {
        # 简化示例
        return s
      }

objects:
  string_utils: StringUtils()
```

在另一个 HPL 文件中导入：

```yaml
imports:
  - utils

main: () => {
    result = utils.string_utils.reverse("hello")
    echo result
  }
```

## 高级用法

### 显式接口定义

在 Python 模块中精确控制暴露给 HPL 的接口：

```python
from hpl_runtime.module_base import HPLModule

# 创建 HPL 模块接口
HPL_MODULE = HPLModule("my_module", "My custom module")

# 注册函数
def add(a, b):
    return a + b

HPL_MODULE.register_function('add', add, 2, 'Add two numbers')

# 注册常量
HPL_MODULE.register_constant('PI', 3.14159, 'Pi constant')
```

### 模块搜索路径

添加自定义模块搜索路径：

```bash
# 添加路径
hpl path --add ./my_modules
hpl path --add /usr/local/hpl/modules

# 查看所有路径
hpl path --list
```

或者在 Python 中：

```python
from hpl_runtime.module_loader import add_module_path

add_module_path('./my_modules')
```

## 示例

### 使用 requests 发送 HTTP 请求

```yaml
imports:
  - requests

main: () => {
    echo "Fetching data..."
    
    response = requests.get("https://httpbin.org/get")
    echo "Status: " + response.status_code
    
    if (response.status_code == 200) :
      data = response.json()
      echo "Origin: " + data.origin
  }
```

### 使用 numpy 进行数值计算

```yaml
imports:
  - numpy

main: () => {
    # 创建数组
    arr = numpy.array([1, 2, 3, 4, 5])
    echo "Array: " + arr
    
    # 计算
    echo "Sum: " + numpy.sum(arr)
    echo "Mean: " + numpy.mean(arr)
    echo "Max: " + numpy.max(arr)
}
```

### 使用 pillow 处理图像

```yaml
imports:
  - PIL

main: () => {
    # 打开图像
    img = PIL.Image.open("input.jpg")
    
    # 获取信息
    echo "Size: " + img.size
    echo "Mode: " + img.mode
    
    # 创建缩略图
    img.thumbnail((128, 128))
    img.save("output.jpg")
    
    echo "Thumbnail created!"
}
```

## 注意事项

1. **包安装位置**：包安装在 `~/.hpl/packages/` 目录下
2. **命名空间**：Python 包的函数和常量自动暴露在模块命名空间下
3. **类型转换**：HPL 会自动处理 Python 和 HPL 之间的类型转换
4. **错误处理**：Python 异常会被捕获并转换为 HPL 错误

## 故障排除

### 包安装失败

```bash
# 检查 pip 是否可用
python -m pip --version

# 手动安装到 HPL 目录
python -m pip install --target ~/.hpl/packages requests
```

### 模块找不到

```bash
# 检查包是否安装
hpl list

# 查看模块搜索路径
hpl path --list

# 添加正确的搜索路径
hpl path --add /path/to/your/modules
```

### 函数调用失败

- 检查函数参数数量是否正确
- 检查参数类型是否兼容
- 查看 Python 模块文档了解函数签名

## 开发自定义模块

### Python 模块模板

```python
"""
My Custom HPL Module
"""

from hpl_runtime.module_base import HPLModule

# 可选：创建显式接口
HPL_MODULE = HPLModule("my_module", "Description")

def my_function(arg1, arg2):
    """函数文档"""
    return result

# 自动接口：函数和变量自动暴露
# 显式接口：精确控制暴露的内容
HPL_MODULE.register_function('my_function', my_function, 2, 'Description')
```

### 测试模块

```bash
# 测试 Python 模块
python -c "import my_module; print(my_module.my_function('test', 123))"

# 在 HPL 中测试
hpl run test_my_module.hpl
```

## 更多资源

- [PyPI - Python Package Index](https://pypi.org/)
- [Python 标准库文档](https://docs.python.org/3/library/)
- [HPL 标准库参考](./HPL语法手册.md)
